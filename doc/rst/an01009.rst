########################################################################
AN01009: Optimizing USB Audio for stereo output, battery powered devices
########################################################################

This application note characterizes the expected power usage of the XMOS
USB Audio reference design running on the XCORE.AI device, configured for
stere- out applications. The second part of this document outlines optional
changes to the hardware and firmware, with the goal of reducing power
consumption and minimising power consumption.

A companion application note, XXX, shows how more power cna be saved by not
using an external DAC.

The USB Audio reference design is optimized for performance,
configurability and low resource usage. The standard reference design
running on the XCORE.AI comfortably fits within the USB bus power envelope
with plenty of power available for support components and audio CODECs.

When powering systems from a battery, a fixed amount of energy is
available. Reduction of power dissipation allows the designer to increase
battery life or keep the same battery life for a smaller battery, bringing
cost and form factor savings. By making different design choices and
constraining the original XMOS USB Audio reference design, various power
optimizations can be applied to help achieve these goals.

[UPDATE LINKS] This application note assumes that the reader is familiar with the `XMOS architecture.
<http://www.xmos.com/published/xcore-architecture?version=latest>`_
and the `XMOS USB Audio reference design. <http://www.xmos.com/products/reference-designs/dj>`_

Overview
--------

The power measurements have been made using the following test harness:

- The XCORE.AI multi channel audio board. This board has a jumper (J24)
  over which the 5V supply to the core power supply can be monitored. Note
  that this excludes 5V supply to 3V3 and 1V8 pins.

- USB Audio library ``lib_xua``. The version used was 4.0.0.

- Host Macbook Air machine running OSX version 12.7.6 (Monterey) with integrated
  USB Audio Class drivers.

A diagram of the chip power measurement method is shown below. There are
multiple power domains within the XCORE.AI device. In this application, all
of the power is drawn through the VSUP (core and PHY supply) and VDDIO (I/O
supply) pins. By multiplying the current and voltage on these rails and
summing both supplies, the total chip power is determined.

.. figure:: images/test_setup.*

            Test setup

For each configuration, basic enumeration and playback was tested on OSX,
and power when playing audio was measured.

[[UPDATE LINKS]] For further information about USB testing and compatibility of XMOS
USB Audio reference designs, please refer to the `USB Audio System
Requirements Guide. <http://www.xmos.com/published/xmos-usb-and-usb-audio-system-requirements-guide>`_

Power measurement and optimizations 
-----------------------------------

A number of different optimizations were applied to the reference design and their
impact was measured. These optimizations can be grouped into categories.

.. points::
 
   - Reduce the clock frequency to 500 MHz from the standard 600 Mhz.
     It can even go down to 400 MHz?

   - Move all the software to one physical core, Slow the switch down, and
     slow the other core down. Note: an extra 3 mW can be saved by
     switching the other core off, but that requires a hardware
     modification to the board as the I2C is connected to that tile.

   - Reduce the core voltage to the bottom of the allowed range (0.85V)
     rather than the middle of the allowed range (0.9V)
     
   - Reference design feature reduction. Reduction of power by lowering the audio sample
     frequency to 48kHz and use of full speed USB Audio Class 1 and full
     speed USB. 

The latter is important as it affects the non-core power consumed.
We compute IO power to be as follows (note these have not yet been measured):

  ========================= ======================= ======================
  Current                   FSRX (12 MBps)          HSRX (480 mbit/s)
  ========================= ======================= ======================
  IVCC33A                   11-40 uA (negligible)   1 mA (3 mW)
  IVCC18A                   4-5 mA (7-9 mW)         30-36 mA (54-65 mW)
  Oscillator, 1.8V CHECK    4 mW                    4 mW
  **Total**                 **13 mW**               **72 mW**
  ========================= ======================= ======================


The table below shows the measured power consumption of XS1-U6 USB Audio reference design,
configured to stereo output, USB Audio Class 2, 192kHz which is typical for DAC type applications.

.. table :: Power saving from reference design feature reduction
  :class: narrow

  +----------------------------+---------------+----------------+---------------+
  |        Configuration       |  VSUP Power   |      I/O Power |    Total      |
  +============================+===============+================+===============+
  | 2 out UAC2 48KHz baseline  |   239 mW      |     72 mW      |   315  mW     |
  | 2 tiles, 7 threads, 600 MHz|               |                |               |
  +----------------------------+---------------+----------------+---------------+  
  | 2 out UAC2 48KHz           |   205 mW      |     72 mW      |   279  mW     |
  | 2 tiles, 7 threads, 500 MHz|               |                |               |
  +----------------------------+---------------+----------------+---------------+  
  | 2 out UAC2 48KHz           |   160 mW      |     72 mW      |   234  mW     |
  | 2 tiles, 7 threads, 500 MHz|               |                |               |
  | tile 0 slow                |               |                |               |
  +----------------------------+---------------+----------------+---------------+  
  | 2 out UAC2 48KHz           |   142.5 mW    |     72 mW      |   217  mW     |
  | 2 tiles, 7 threads, 500 MHz|               |                |               |
  | tile 0 slow, low voltage   |               |                |               |
  +----------------------------+---------------+----------------+---------------+  
  | 2 out UAC1 48KHz           |   142.5 mW    |     13 mW      |   156  mW     |
  | 2 tiles, 7 threads, 500 MHz|               |                |               |
  | tile 0 slow, low voltage   |               |                |               |
  +----------------------------+---------------+----------------+---------------+  


Conclusion
----------

This application note shows how some simple design optimizations can be made to reduce
overall power consumption by close to 2x, compared with the baseline reference design.
